$ terraform init
$ terraform apply -auto-approve -target=module.individual_external_tables

module.individual_external_tables.null_resource.bq_get_schema_external_table_old (local-exec): Executing: ["/bin/sh" "-c" "bq show --schema --format=prettyjson my-project-123:bartek_external_table.external_table_old | jq 'del(.[] | select((.name == \"year\") or (.name == \"month\") or (.name == \"day\") or (.name == \"hour\")))' > schema_old.json"]
module.individual_external_tables.null_resource.bq_get_schema_external_table_new (local-exec): Executing: ["/bin/sh" "-c" "bq show --schema --format=prettyjson my-project-123:bartek_external_table.external_table_new | jq 'del(.[] | select((.name == \"year\") or (.name == \"month\") or (.name == \"day\") or (.name == \"hour\")))' > schema_new.json"]

module.individual_external_tables.null_resource.bq_select_external_table_old (local-exec): | myRequiredInt | myRequiredString | myOptionalString | myNullableString | myRequiredBoolean | myRequiredBytes | myBytesDecimal | myRequiredTimestamp | myOptionalTimestamp | myRequiredDate | myRequiredArrayLongs |                  myRequiredSubRecord                   |                 myOptionalSubRecord                  |                 myNullableSubRecord                 |                                           myOptionalArraySubRecords                                            | myNullableArraySubRecords | year | month | day | hour |
module.individual_external_tables.null_resource.bq_select_external_table_old (local-exec): |           123 | abc              | NULL             | NULL             |              true |        QUJDMTIz |           1.23 | 2023-11-18 11:54:11 |                NULL |     2023-11-18 |        ["1","2","3"] | {"myRequiredDouble":"1.0","myRequiredBoolean":"false"} | {"myRequiredFloat":"2.0","myRequiredBoolean":"true"} | {"myRequiredLong":"12","myRequiredBoolean":"false"} | [{"myRequiredBoolean":"true","myOptionalBoolean":null},{"myRequiredBoolean":"false","myOptionalBoolean":null}] |                        [] | 2023 | 01    | 01  | 00   |

module.individual_external_tables.null_resource.bq_select_external_table_new (local-exec): | myRequiredInt | myRequiredString | myOptionalString | myNullableString | myRequiredBoolean | myRequiredBytes | myBytesDecimal | myRequiredTimestamp | myOptionalTimestamp | myRequiredDate | myRequiredArrayLongs |                                myRequiredSubRecord                                 |                               myOptionalSubRecord                                |                               myNullableSubRecord                               |                                                                   myOptionalArraySubRecords                                                                    | myNullableArraySubRecords | myNewOptionalLong | year | month | day | hour |
module.individual_external_tables.null_resource.bq_select_external_table_new (local-exec): |           123 | abc              | NULL             | NULL             |              true |        QUJDMTIz |           1.23 | 2023-11-18 11:54:01 |                NULL |     2023-11-18 |        ["1","2","3"] | {"myRequiredDouble":"1.0","myRequiredBoolean":"false","myNewOptionalString":"def"} | {"myRequiredFloat":"2.0","myRequiredBoolean":"true","myNewOptionalString":"qrs"} | {"myRequiredLong":"12","myRequiredBoolean":"false","myNewOptionalString":"xyz"} | [{"myRequiredBoolean":"true","myOptionalBoolean":null,"myNewOptionalInt":"10"},{"myRequiredBoolean":"false","myOptionalBoolean":null,"myNewOptionalInt":"20"}] |                        [] |                 1 | 2023 | 01    | 01  | 01   |

$ ls -la schema*.json
-rw-r--r--  1 sg0212148  staff   3.4K Nov 19 18:37 schema_new.json
-rw-r--r--  1 sg0212148  staff   2.8K Nov 19 18:37 schema_old.json


$ terraform apply -auto-approve -target=module.external_table -var schema_file=schema_old.json

module.external_table.null_resource.bq_select_external_table (local-exec): Executing: ["/bin/sh" "-c" "bq query --use_legacy_sql=false 'SELECT * FROM `bartek_external_table.external_table`'"]

BigQuery error in query operation: Error processing job 'my-project-123:bqjob_r5f6f3ba38d538fa5_0000018be8b0d2ba_1': Error while reading
table: bartek_external_table.external_table, error message: Failed to expand
table bartek_external_table.external_table with file pattern gs://my-project-123-bartek-external-table/external_table/*.parquet: matched no files.
File: gs://my-project-123-bartek-external-table/external_table/*.parquet

$ ./copy-old-file-to-external-table-gcs-location.sh my-project-123
Executing: gsutil cp myNestedRecordFewerFields.parquet gs://my-project-123-bartek-external-table/external_table/year=2023/month=01/day=01/hour=00/myNestedRecordFewerFields.parquet

$ ./select-external-table.sh my-project-123
Executing: bq query --use_legacy_sql=false "SELECT * FROM my-project-123.bartek_external_table.external_table"


| myRequiredInt | myRequiredString | myOptionalString | myNullableString | myRequiredBoolean | myRequiredBytes | myBytesDecimal | myRequiredTimestamp | myOptionalTimestamp | myRequiredDate | myRequiredArrayLongs |                  myRequiredSubRecord                   |                 myOptionalSubRecord                  |                 myNullableSubRecord                 |                                           myOptionalArraySubRecords                                            | myNullableArraySubRecords | year | month | day | hour |
+---------------+------------------+------------------+------------------+-------------------+-----------------+----------------+---------------------+---------------------+----------------+----------------------+--------------------------------------------------------+------------------------------------------------------+-----------------------------------------------------+----------------------------------------------------------------------------------------------------------------+---------------------------+------+-------+-----+------+
|           123 | abc              | NULL             | NULL             |              true |        QUJDMTIz |           1.23 | 2023-11-18 11:54:11 |                NULL |     2023-11-18 |        ["1","2","3"] | {"myRequiredDouble":"1.0","myRequiredBoolean":"false"} | {"myRequiredFloat":"2.0","myRequiredBoolean":"true"} | {"myRequiredLong":"12","myRequiredBoolean":"false"} | [{"myRequiredBoolean":"true","myOptionalBoolean":null},{"myRequiredBoolean":"false","myOptionalBoolean":null}] |                        [] | 2023 | 01    | 01  | 00   |

$ ./copy-new-file-to-external-table-gcs-location.sh my-project-123
Executing: gsutil cp myNestedRecordMoreFields.parquet gs://my-project-123-bartek-external-table/external_table/year=2023/month=01/day=01/hour=01/myNestedRecordMoreFields.parquet


$ ./select-external-table.sh my-project-123
| myRequiredInt | myRequiredString | myOptionalString | myNullableString | myRequiredBoolean | myRequiredBytes | myBytesDecimal | myRequiredTimestamp | myOptionalTimestamp | myRequiredDate | myRequiredArrayLongs |                  myRequiredSubRecord                   |                 myOptionalSubRecord                  |                 myNullableSubRecord                 |                                           myOptionalArraySubRecords                                            | myNullableArraySubRecords | year | month | day | hour |
+---------------+------------------+------------------+------------------+-------------------+-----------------+----------------+---------------------+---------------------+----------------+----------------------+--------------------------------------------------------+------------------------------------------------------+-----------------------------------------------------+----------------------------------------------------------------------------------------------------------------+---------------------------+------+-------+-----+------+
|           123 | abc              | NULL             | NULL             |              true |        QUJDMTIz |           1.23 | 2023-11-18 11:54:01 |                NULL |     2023-11-18 |        ["1","2","3"] | {"myRequiredDouble":"1.0","myRequiredBoolean":"false"} | {"myRequiredFloat":"2.0","myRequiredBoolean":"true"} | {"myRequiredLong":"12","myRequiredBoolean":"false"} | [{"myRequiredBoolean":"true","myOptionalBoolean":null},{"myRequiredBoolean":"false","myOptionalBoolean":null}] |                        [] | 2023 | 01    | 01  | 01   |
|           123 | abc              | NULL             | NULL             |              true |        QUJDMTIz |           1.23 | 2023-11-18 11:54:11 |                NULL |     2023-11-18 |        ["1","2","3"] | {"myRequiredDouble":"1.0","myRequiredBoolean":"false"} | {"myRequiredFloat":"2.0","myRequiredBoolean":"true"} | {"myRequiredLong":"12","myRequiredBoolean":"false"} | [{"myRequiredBoolean":"true","myOptionalBoolean":null},{"myRequiredBoolean":"false","myOptionalBoolean":null}] |                        [] | 2023 | 01    | 01  | 00   |


$ terraform apply -auto-approve -target=module.external_table -var schema_file=schema_new.json

module.external_table.google_bigquery_table.external_table: Destroying... [id=projects/my-project-123/datasets/bartek_external_table/tables/external_table]
module.external_table.google_bigquery_table.external_table: Creation complete after 1s [id=projects/my-project-123/datasets/bartek_external_table/tables/external_table]

$ ./select-external-table.sh my-project-123
Executing: bq query --use_legacy_sql=false "SELECT * FROM my-project-123.bartek_external_table.external_table"
| myRequiredInt | myRequiredString | myOptionalString | myNullableString | myRequiredBoolean | myRequiredBytes | myBytesDecimal | myRequiredTimestamp | myOptionalTimestamp | myRequiredDate | myRequiredArrayLongs |                                myRequiredSubRecord                                 |                               myOptionalSubRecord                                |                               myNullableSubRecord                               |                                                                   myOptionalArraySubRecords                                                                    | myNullableArraySubRecords | myNewOptionalLong | year | month | day | hour |
+---------------+------------------+------------------+------------------+-------------------+-----------------+----------------+---------------------+---------------------+----------------+----------------------+------------------------------------------------------------------------------------+----------------------------------------------------------------------------------+---------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------+-------------------+------+-------+-----+------+
|           123 | abc              | NULL             | NULL             |              true |        QUJDMTIz |           1.23 | 2023-11-18 11:54:01 |                NULL |     2023-11-18 |        ["1","2","3"] | {"myRequiredDouble":"1.0","myRequiredBoolean":"false","myNewOptionalString":"def"} | {"myRequiredFloat":"2.0","myRequiredBoolean":"true","myNewOptionalString":"qrs"} | {"myRequiredLong":"12","myRequiredBoolean":"false","myNewOptionalString":"xyz"} | [{"myRequiredBoolean":"true","myOptionalBoolean":null,"myNewOptionalInt":"10"},{"myRequiredBoolean":"false","myOptionalBoolean":null,"myNewOptionalInt":"20"}] |                        [] |                 1 | 2023 | 01    | 01  | 01   |
|           123 | abc              | NULL             | NULL             |              true |        QUJDMTIz |           1.23 | 2023-11-18 11:54:11 |                NULL |     2023-11-18 |        ["1","2","3"] |  {"myRequiredDouble":"1.0","myRequiredBoolean":"false","myNewOptionalString":null} |  {"myRequiredFloat":"2.0","myRequiredBoolean":"true","myNewOptionalString":null} |  {"myRequiredLong":"12","myRequiredBoolean":"false","myNewOptionalString":null} | [{"myRequiredBoolean":"true","myOptionalBoolean":null,"myNewOptionalInt":null},{"myRequiredBoolean":"false","myOptionalBoolean":null,"myNewOptionalInt":null}] |                        [] |              NULL | 2023 | 01    | 01  | 00   |
